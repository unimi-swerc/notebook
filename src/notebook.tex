\documentclass[8pt,a4paper,landscape,oneside]{amsart}
% \usepackage[utf8]{inputenc} -- lualatex uses utf8 by default

\usepackage{amsmath, amsthm, amssymb, amsfonts}
\usepackage[italian]{babel}
\usepackage{booktabs}
\usepackage{caption}
\usepackage{color}
\usepackage{datetime}
\usepackage{enumitem}
\usepackage{fancyhdr}
\usepackage{float}
\usepackage{fullpage}
\usepackage[top=3pt, bottom=1cm, left=0.6cm, right=0.3cm]{geometry}
\usepackage{graphicx}
\usepackage{lmodern}
\usepackage[cache=false]{minted}
\usepackage{multicol}
\usepackage{subcaption}
\usepackage{titling}
\usepackage{luacode}
\usepackage{fontspec}
\setmonofont[Scale=MatchUppercase]{DejaVuSansMono}

\newcommand{\subtitle}[1]{\posttitle{\par\end{center}\begin{center}\large#1\end{center}\vskip0.1em\vspace{-2em}}}

% Minted
\renewcommand{\theFancyVerbLine}{\ttfamily{\footnotesize\arabic{FancyVerbLine}}\hspace{-8pt}} % mono line numbers
\setminted{
    fontsize=\normalsize,
    baselinestretch=0.85,
    xleftmargin=1.5em,
    xrightmargin=-0.3cm,
    linenos,
    breaklines,
    mathescape,
    firstnumber=1
}
\newcommand{\codecpp}[2]{\inputminted[firstline=#2]{cpp}{'\detokenize{#1}'}}
\newcommand{\codepy}[1]{\inputminted{python}{'\detokenize{#1}'}}

% Header/Footer
\pagestyle{fancy}
\lhead{Università degli Studi di Milano - LaStatale Yellow}
\rhead{\thepage}
\cfoot{}
\setlength{\headheight}{15.2pt}
\setlength{\droptitle}{-20pt}
\posttitle{\par\end{center}}
\renewcommand{\headrulewidth}{0.4pt}
\renewcommand{\footrulewidth}{0.4pt}
\setcounter{tocdepth}{2}

% Math and bit operators
\DeclareMathOperator{\lcm}{lcm}
\newcommand*\BitAnd{\mathrel{\&}}
\newcommand*\BitOr{\mathrel{|}}
\newcommand*\ShiftLeft{\ll}
\newcommand*\ShiftRight{\gg}
\newcommand*\BitNeg{\ensuremath{\mathord{\sim}}}
\DeclareRobustCommand{\Stirling}{\genfrac{\{}{\}}{0pt}{}}
\DeclareRobustCommand{\stirling}{\genfrac{[}{]}{0pt}{}}

% Title/Author
\author{LaStatale Yellow 2021-2022}
\title{Università degli Studi di Milano - LaStatale Yellow}
\subtitle{Team Reference Document}
\date{\ddmmyyyydate{\today{}}}

\begin{document}
\begin{multicols*}{3}
\maketitle
\thispagestyle{fancy}
\vspace{-3em}
\renewcommand{\baselinestretch}{0.9}\normalsize
\tableofcontents
\vspace{-3em}
\begin{luacode*}

function ls(dir)
    local files = {}
    for file in lfs.dir(dir) do
        table.insert(files, file)
    end
    table.sort(files)
    return ipairs(files)
end

function codecpp(filename)
    local file = io.open(filename, "r")
    local skipped_lines = 1
    while (file:read():match("^///")) do
        skipped_lines = skipped_lines + 1
    end
    tex.print("\\codecpp{" .. filename .. "}{" .. skipped_lines .. "}")
end

local current_dir = lfs.currentdir() .. "/src"
for _, section in ls(current_dir) do
    if not section:find("%.") then
        local section_dir = current_dir .. "/" .. section
        tex.print("\\vspace{-1em}" .. "\\section{" .. section:gsub("^%l", string.upper) .. "}")
        for _, subsection in ls(section_dir) do
            local subsection_file = section_dir .. "/" .. subsection
            local subsection_name = subsection:gsub("^(.*)%..*$", "%1")
            if subsection:find("%.cpp$") then
                tex.print("\\subsection{" .. subsection_name .. "}" .. "\\vspace{-1em}")
                codecpp(subsection_file)
            end
            if subsection:find("%.py$") then
                tex.print("\\subsection{" .. subsection_name .. "}" .. "\\vspace{-1em}")
                tex.print("\\codepy{" .. subsection_file .. "}")
            end
            if subsection:find("%.tex$") then
                tex.print("\\subsection{" .. subsection_name .. "}" .. "\\vspace{-1em}")
                tex.print("\\input{" .. subsection_file .. "}")
            end
            if not subsection:find("%.") then
                local subsection_dir = section_dir .. "/" .. subsection
                tex.print("\\subsection{" .. subsection:gsub("^%l", string.upper) .. "}")
                for _, subsubsection in ls(subsection_dir) do
                    subsubsection_file = subsection_dir .. "/" .. subsubsection
                    subsubsection_name = subsubsection:gsub("^(.*)%..*$", "%1")
                    if subsubsection:find("%.cpp$") then
                        tex.print("\\subsubsection{" .. subsubsection_name .. "}" .. "\\vspace{-1em}")
                        codecpp(subsubsection_file)
                    end
                    if subsubsection:find("%.py$") then
                        tex.print("\\subsubsection{" .. subsubsection_name .. "}" .. "\\vspace{-1em}")
                        tex.print("\\codepy{" .. subsubsection_file .. "}")
                    end
                    if subsubsection:find("%.tex$") then
                        tex.print("\\subsubsection{" .. subsubsection_name .. "}" .. "\\vspace{-1em}")
                        tex.print("\\input{" .. subsubsection_file .. "}")
                    end
                end
            end
        end
    end
end

\end{luacode*}
\end{multicols*}
\end{document}
