\documentclass[8pt,a4paper,landscape,oneside]{amsart}
\usepackage{amsmath, amsthm, amssymb, amsfonts}
\usepackage[italian]{babel}
\usepackage{fancyhdr}
\usepackage{fullpage}
\usepackage[top=0pt, bottom=0.8cm, left=0.6cm, right=0.3cm]{geometry}
\usepackage[cache=false]{minted}
\usepackage{multicol}
\usepackage{titling}
\usepackage{luacode}
\usepackage{fontspec}
\usepackage{extramarks}
\usepackage{hyperref}
\usepackage{xpatch}
\usepackage{pgfornament}
\usepackage{psvectorian}
\usepackage{tikz}
\usetikzlibrary{calc}
\setmonofont[Scale=MatchUppercase]{DejaVuSansMono}

% Minted
\renewcommand{\theFancyVerbLine}{\ttfamily{\footnotesize\arabic{FancyVerbLine}}\hspace{-8pt}} % mono line numbers
\setminted{
    fontsize=\normalsize,
    baselinestretch=0.91,
    xleftmargin=1.5em,
    xrightmargin=-0.3cm,
    linenos,
    breaklines,
    mathescape,
    firstnumber=1
}
\newcommand{\codecpp}[2]{\inputminted[firstline=#2]{cpp}{'\detokenize{#1}'}}
\newcommand{\codepy}[1]{\inputminted{python}{'\detokenize{#1}'}}

% Header/Footer
\pagestyle{fancy}
\renewcommand{\sectionmark}[1]{\markboth{\thesection.\ \MakeUppercase{#1}}{\thesection.\ \MakeUppercase{#1}}}
\renewcommand{\subsectionmark}[1]{\markright{\thesubsection.\ \MakeUppercase{#1}}}
\lhead{Universit√† degli Studi di Milano - LaStatale Blue}
\chead{
    \ifthenelse{\equal{\firstrightmark}{\lastrightmark}}
        {\firstrightmark}
        {\firstrightmark\ -\ \lastrightmark}
}
\rhead{\thepage}
\cfoot{}
\setlength{\headheight}{15pt}
\setlength{\droptitle}{-26pt}
\posttitle{\par\end{center}}
\renewcommand{\headrulewidth}{0.4pt}
%\renewcommand{\footrulewidth}{0.4pt}
\makeatletter
\xapptocmd{\@sect}{\csname #1mark\endcsname{#7} \vspace{-3pt}}{}{}
\makeatother

% Math operators
\DeclareRobustCommand{\Stirling}{\genfrac{\{}{\}}{0pt}{}}
\DeclareRobustCommand{\stirling}{\genfrac{[}{]}{0pt}{}}

% Section ornaments
\newcommand{\sectionOrnament}[2]{
    \section{#1}
    \vspace{-1.3em}
    \begin{center}
        \;\rput[r](-2pt,6pt){\pgfornament[height=2.5em]{#2}}
        \phantom{1. #1}\quad
        \rput[l](2pt,6pt){\pgfornament[height=2.5em,symmetry=v]{#2}}
    \end{center}
}

% Title/Author
\author{LaStatale Blue 2022-2023}
\title{Team Reference Document}
\date{\vspace{-1.7em}\today{}}
\setcounter{tocdepth}{2} % table of content depth

\begin{document}
\begin{multicols*}{3}
\markboth{0. INDICE}{0. INDICE}
\maketitle
\thispagestyle{fancy}
\vspace{-1em}
\renewcommand{\baselinestretch}{1}\normalsize

% Table of contents
\addtocontents{toc}{\setlength{\columnsep}{-0.3cm}\protect\begin{multicols}{2}}

\hspace{-0.8cm}
\begin{tikzpicture}[every node/.style={inner sep=0pt}]

\node[text width=9.3cm,align=center](Text){{\small \selectfont \tableofcontents}};

\node[shift={(0cm, -0.1cm)}, anchor=north west](NW) at (Text.north west) {\pgfornament[width=1.75cm]{37}};
\node[coordinate, shift={(0cm, 0cm)}](NW2) at (NW.south west) {};
\node[coordinate, shift={(0cm, 0.05cm)}](NW3) at (NW.north east) {};
\node[coordinate, shift={(-0.05cm, 0cm)}](W)        at (Text.west) {};
\node[shift={(0cm, -0.6cm)}, anchor=south west](SW) at (Text.south west) {\pgfornament[width=1.75cm,symmetry=h]{37}};
\node[coordinate, shift={(0cm, 0cm)}](SW2) at (SW.north west) {};
\node[coordinate, shift={(0cm, -0.05cm)}](SW3) at (SW.south east) {};

\node[shift={(0.4cm, -0.1cm)}, anchor=north east](NE) at (Text.north east) {\pgfornament[width=1.75cm]{38}};
\node[coordinate, shift={(0.4cm, 0cm)}](NE2) at (NE.south east) {};
\node[coordinate, shift={(0.0cm, 0.05cm)}](NE3) at (NE.north west) {};
\node[coordinate, shift={(0.1cm, 0cm)}](E)        at (Text.east) {};
\node[shift={(0.4cm, -0.6cm)}, anchor=south east](SE) at (Text.south east) {\pgfornament[width=1.75cm,symmetry=h]{38}};
\node[coordinate, shift={(0.4cm, 0cm)}](SE2) at (SE.north east) {};
\node[coordinate, shift={(0.0cm, -0.05cm)}](SE3) at (SE.south west) {};

\pgfornamenthline{NE3}{NW3}{north}{85}
\pgfornamenthline{SW3}{SE3}{south}{85}

\pgfornamentvline{NW2}{W}{west}{85}
\pgfornamentvline{W}{SW2}{west}{85}

\pgfornamentvline{E}{NE2}{east}{85}
\pgfornamentvline{SE2}{E}{east}{85}

\end{tikzpicture}
\vspace{-1.6em}

\begin{luacode*}

function ls(dir)
    local files = {}
    for file in lfs.dir(dir) do
        table.insert(files, file)
    end
    table.sort(files)
    return ipairs(files)
end

function codecpp(filename)
    local file = io.open(filename, "r")
    local skipped_lines = 1
    while (file:read():match("^///")) do
        skipped_lines = skipped_lines + 1
    end
    tex.print("\\codecpp{" .. filename .. "}{" .. skipped_lines .. "}")
end

local sectionOrnaments = {190, 158, 193, 156, 113, 104, 102, 158}
local sectionIndex = 1

local current_dir = lfs.currentdir() .. "/src"
for _, section in ls(current_dir) do
    if not section:find("%.") then
        local section_dir = current_dir .. "/" .. section
        tex.print("\\sectionOrnament{" .. section:gsub("^%l", string.upper) .. "}{" .. sectionOrnaments[sectionIndex] .. "}")
        sectionIndex = sectionIndex + 1
        for _, subsection in ls(section_dir) do
            local subsection_file = section_dir .. "/" .. subsection
            local subsection_name = subsection:gsub("^(.*)%..*$", "%1")
            if subsection:find("%.cpp$") then
                tex.print("\\subsection{" .. subsection_name .. "}")
                codecpp(subsection_file)
            end
            if subsection:find("%.py$") then
                tex.print("\\subsection{" .. subsection_name .. "}")
                tex.print("\\codepy{" .. subsection_file .. "}")
            end
            if subsection:find("%.tex$") then
                tex.print("\\subsection{" .. subsection_name .. "}")
                tex.print("\\input{" .. subsection_file .. "}")
            end
            if not subsection:find("%.") then
                local subsection_dir = section_dir .. "/" .. subsection
                tex.print("\\subsection{" .. subsection:gsub("^%l", string.upper) .. "}")
                for _, subsubsection in ls(subsection_dir) do
                    subsubsection_file = subsection_dir .. "/" .. subsubsection
                    subsubsection_name = subsubsection:gsub("^(.*)%..*$", "%1")
                    if subsubsection:find("%.cpp$") then
                        tex.print("\\subsubsection{" .. subsubsection_name .. "}")
                        codecpp(subsubsection_file)
                    end
                    if subsubsection:find("%.py$") then
                        tex.print("\\subsubsection{" .. subsubsection_name .. "}")
                        tex.print("\\codepy{" .. subsubsection_file .. "}")
                    end
                    if subsubsection:find("%.tex$") then
                        tex.print("\\subsubsection{" .. subsubsection_name .. "}")
                        tex.print("\\input{" .. subsubsection_file .. "}")
                    end
                end
            end
        end
    end
end

\end{luacode*}
\addtocontents{toc}{\protect\end{multicols}}
\end{multicols*}
\end{document}
